<!-- TOAST -->
<app-toast
  [show]="showToast()"
  [type]="toastType()"
  [title]="toastTitle()"
  [message]="toastMessage()"
  (close)="cerrarToast()">
</app-toast>

<!-- CONTAINER PRINCIPAL -->
<div class="min-h-screen bg-gray-50 dark:bg-[#102211]">
  
  <!-- HEADER -->
  <div class="bg-white dark:bg-[#182c19] border-b-2 border-gray-200 dark:border-[#2a452b] sticky top-0 z-40 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button 
            (click)="volver()"
            class="w-12 h-12 rounded-xl border-2 border-gray-300 dark:border-gray-600 hover:border-[#2E7D32] hover:bg-green-50 dark:hover:bg-green-900/20 flex items-center justify-center transition-all group"
            aria-label="Volver">
            <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-hover:text-[#2E7D32]">arrow_back</span>
          </button>
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-[#2E7D32]">event_note</span>
              Generar Fixture
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
              {{ campeonato()?.nombre }}
            </p>
          </div>
        </div>

        <!-- Indicador de equipos -->
        <div class="px-4 py-2 rounded-lg" 
             [class]="tieneEquipos() ? 'bg-green-100 dark:bg-green-900/30 border-2 border-green-300' : 'bg-red-100 dark:bg-red-900/30 border-2 border-red-300'">
          <p class="text-xs font-semibold" 
             [class]="tieneEquipos() ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'">
            Equipos Aprobados
          </p>
          <p class="text-2xl font-bold" 
             [class]="tieneEquipos() ? 'text-green-900 dark:text-green-100' : 'text-red-900 dark:text-red-100'">
            {{ equiposInscritos().length }}
          </p>
        </div>
      </div>

      <!-- Breadcrumb de pasos -->
      <div class="flex items-center gap-2 mt-6">
        <div [class]="'px-4 py-2 rounded-lg font-semibold text-sm transition-all ' + 
                      (vistaActual() === 'seleccion' ? 'bg-[#2E7D32] text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400')">
          1. Selección
        </div>
        <span class="material-symbols-outlined text-gray-400">chevron_right</span>
        <div [class]="'px-4 py-2 rounded-lg font-semibold text-sm transition-all ' + 
                      (vistaActual() === 'configuracion' ? 'bg-[#2E7D32] text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400')">
          2. Configuración
        </div>
        <span class="material-symbols-outlined text-gray-400">chevron_right</span>
        <div [class]="'px-4 py-2 rounded-lg font-semibold text-sm transition-all ' + 
                      (vistaActual() === 'preview' ? 'bg-[#2E7D32] text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400')">
          3. Vista Previa
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading()" class="flex items-center justify-center py-20">
    <div class="text-center">
      <div class="inline-block w-16 h-16 border-4 border-gray-200 border-t-[#2E7D32] rounded-full animate-spin mb-4"></div>
      <p class="text-gray-600 dark:text-gray-400 font-medium">Generando fixture...</p>
    </div>
  </div>

  <!-- CONTENIDO -->
  <div *ngIf="!loading()" class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">

    <!-- ========================================== -->
    <!-- VISTA 1: SELECCIÓN DE TIPO DE CAMPEONATO -->
    <!-- ========================================== -->
    <div *ngIf="vistaActual() === 'seleccion'">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          Selecciona el tipo de competición
        </h2>
        <p class="text-gray-600 dark:text-gray-400">
          Elige cómo se organizará tu campeonato
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- LIGA (TODOS CONTRA TODOS) -->
        <button 
          (click)="seleccionarTipo('liga')"
          class="group p-8 rounded-2xl border-3 border-gray-200 dark:border-gray-700 hover:border-[#2E7D32] hover:bg-green-50 dark:hover:bg-green-900/10 transition-all text-center bg-white dark:bg-[#182c19]">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-[#2E7D32] to-[#1B5E20] flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-white text-4xl">emoji_events</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
            Liga
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            Todos contra todos. Cada equipo juega con todos los demás equipos.
          </p>
          <div class="text-sm text-gray-500 dark:text-gray-500 space-y-1">
            <p>✓ Ida y vuelta opcional</p>
            <p>✓ Tabla de posiciones</p>
            <p>✓ Ideal para 4-20 equipos</p>
          </div>
        </button>

        <!-- ELIMINACIÓN DIRECTA -->
        <button 
          (click)="seleccionarTipo('eliminacion_directa')"
          class="group p-8 rounded-2xl border-3 border-gray-200 dark:border-gray-700 hover:border-[#2E7D32] hover:bg-green-50 dark:hover:bg-green-900/10 transition-all text-center bg-white dark:bg-[#182c19]">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-[#2E7D32] to-[#1B5E20] flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-white text-4xl">trending_up</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
            Eliminación Directa
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            Sistema de bracket. El que pierde queda eliminado.
          </p>
          <div class="text-sm text-gray-500 dark:text-gray-500 space-y-1">
            <p>✓ Octavos, cuartos, semifinal, final</p>
            <p>✓ Formato copero</p>
            <p>✓ Ideal para 8-32 equipos</p>
          </div>
        </button>

        <!-- FASE DE GRUPOS + ELIMINACIÓN -->
        <button 
          (click)="seleccionarTipo('fase_grupos')"
          class="group p-8 rounded-2xl border-3 border-gray-200 dark:border-gray-700 hover:border-[#2E7D32] hover:bg-green-50 dark:hover:bg-green-900/10 transition-all text-center bg-white dark:bg-[#182c19]">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-[#2E7D32] to-[#1B5E20] flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-white text-4xl">account_tree</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
            Fase de Grupos
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            Grupos + Eliminación. Combina ambos sistemas.
          </p>
          <div class="text-sm text-gray-500 dark:text-gray-500 space-y-1">
            <p>✓ Grupos A, B, C, D...</p>
            <p>✓ Clasifican los mejores</p>
            <p>✓ Ideal para 16-32 equipos</p>
          </div>
        </button>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- VISTA 2: CONFIGURACIÓN -->
    <!-- ========================================== -->
    <div *ngIf="vistaActual() === 'configuracion'">
      <button 
        (click)="volverASeleccion()"
        class="mb-6 px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-[#2E7D32] text-gray-700 dark:text-gray-300 font-semibold flex items-center gap-2 transition-all">
        <span class="material-symbols-outlined">arrow_back</span>
        Volver a selección
      </button>

      <div class="bg-white dark:bg-[#182c19] rounded-2xl border-2 border-gray-200 dark:border-[#2a452b] shadow-sm p-6 sm:p-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
          <span class="material-symbols-outlined text-[#2E7D32]">tune</span>
          Configuración del Fixture
        </h2>

        <form [formGroup]="configuracionForm" class="space-y-6">
          
          <!-- Fecha de inicio -->
          <div>
            <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">
              Fecha de Inicio *
            </label>
            <app-datepicker
              [value]="configuracionForm.get('fecha_inicio')?.value"
              (valueChange)="configuracionForm.patchValue({fecha_inicio: $event})"
              placeholder="Selecciona la fecha de inicio">
            </app-datepicker>
            
          </div>

          <!-- Días entre jornadas -->
          <div>
            <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">
              Días entre jornadas *
            </label>
            <input 
              type="number"
              formControlName="dias_entre_jornadas"
              min="1"
              max="30"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-4 focus:ring-[#2E7D32]/20 focus:border-[#2E7D32] transition-all">
            <p class="text-sm text-gray-500 mt-1">Número de días entre cada jornada</p>
          </div>

          <!-- Horarios -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">
                Hora del primer partido *
              </label>
              <input 
                type="time"
                formControlName="hora_inicio"
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-4 focus:ring-[#2E7D32]/20 focus:border-[#2E7D32] transition-all">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">
                Hora del segundo partido *
              </label>
              <input 
                type="time"
                formControlName="hora_segundo_partido"
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-4 focus:ring-[#2E7D32]/20 focus:border-[#2E7D32] transition-all">
            </div>
          </div>

          <!-- Incluir vuelta (solo para liga) -->
          <div *ngIf="tipoSeleccionado() === 'liga'" class="flex items-center justify-between p-4 rounded-xl bg-gray-50 dark:bg-gray-800">
            <div>
              <p class="font-bold text-gray-900 dark:text-white">Incluir partidos de vuelta</p>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Cada equipo jugará como local y visitante
              </p>
            </div>
            <button 
              type="button"
              (click)="configuracionForm.patchValue({incluir_vuelta: !configuracionForm.value.incluir_vuelta})"
              [class]="configuracionForm.value.incluir_vuelta ? 'bg-[#2E7D32]' : 'bg-gray-300'"
              class="relative inline-flex h-8 w-14 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#2E7D32] focus:ring-offset-2">
              <span 
                [class]="configuracionForm.value.incluir_vuelta ? 'translate-x-7' : 'translate-x-1'"
                class="inline-block h-6 w-6 transform rounded-full bg-white transition-transform">
              </span>
            </button>
          </div>

          <!-- Número de grupos (solo para fase_grupos) -->
          <div *ngIf="tipoSeleccionado() === 'fase_grupos'">
            <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">
              Número de grupos *
            </label>
            <input 
              type="number"
              formControlName="numero_grupos"
              min="2"
              max="8"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-4 focus:ring-[#2E7D32]/20 focus:border-[#2E7D32] transition-all">
            <p class="text-sm text-gray-500 mt-1">Grupos A, B, C, D... (mínimo 2, máximo 8)</p>
          </div>

          <!-- Botón generar preview -->
          <div class="pt-6 border-t-2 border-gray-200 dark:border-gray-700">
            <button 
              type="button"
              (click)="generarPreview()"
              [disabled]="!configuracionForm.valid"
              class="w-full sm:w-auto px-8 py-4 rounded-xl bg-[#2E7D32] text-white font-bold hover:bg-[#1B5E20] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl">
              <span class="material-symbols-outlined">visibility</span>
              Ver Vista Previa
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- VISTA 3: PREVIEW DEL FIXTURE -->
    <!-- ========================================== -->
    <div *ngIf="vistaActual() === 'preview'">
      <div class="flex items-center justify-between mb-6">
        <button 
          (click)="volverAConfiguracion()"
          class="px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-[#2E7D32] text-gray-700 dark:text-gray-300 font-semibold flex items-center gap-2 transition-all">
          <span class="material-symbols-outlined">arrow_back</span>
          Volver a configuración
        </button>

        <button 
          (click)="confirmarGeneracion()"
          [disabled]="!puedeGenerarFixture()"
          class="px-8 py-4 rounded-xl bg-[#2E7D32] text-white font-bold hover:bg-[#1B5E20] disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
          <span class="material-symbols-outlined">check_circle</span>
          {{ tieneEquipos() ? 'Confirmar y Generar Fixture' : 'No hay equipos suficientes' }}
        </button>
      </div>

      <!-- Alert si no hay equipos -->
      <div *ngIf="!tieneEquipos()" class="bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-700 rounded-xl p-6 mb-6">
        <div class="flex items-start gap-4">
          <span class="material-symbols-outlined text-4xl text-red-600">warning</span>
          <div class="flex-1">
            <h3 class="text-xl font-bold text-red-900 dark:text-red-100 mb-2">
              No puedes generar el fixture todavía
            </h3>
            <p class="text-red-700 dark:text-red-300 mb-4">
              Necesitas al menos 2 equipos aprobados para generar el fixture. Actualmente tienes {{ equiposInscritos().length }} equipos.
            </p>
            <button 
              (click)="volver()"
              class="px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-all flex items-center gap-2">
              <span class="material-symbols-outlined">how_to_reg</span>
              Ir a aprobar equipos
            </button>
          </div>
        </div>
      </div>

      <!-- Vista previa de grupos (si es fase_grupos) -->
      <div *ngIf="tipoSeleccionado() === 'fase_grupos' && Object.keys(gruposPreview()).length > 0" class="mb-6">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Distribución de Grupos
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div *ngFor="let grupo of Object.keys(gruposPreview())" 
               class="bg-white dark:bg-[#182c19] rounded-xl border-2 border-gray-200 dark:border-[#2a452b] p-4">
            <h4 class="text-lg font-bold text-[#2E7D32] mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined">group</span>
              Grupo {{ grupo }}
            </h4>
            <ul class="space-y-2">
              <li *ngFor="let equipo of gruposPreview()[grupo]; let i = index" 
                  class="text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-[#2E7D32] text-white flex items-center justify-center text-xs font-bold">
                  {{ i + 1 }}
                </span>
                {{ equipo }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Partidos por jornada -->
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
        Calendario de Partidos
      </h3>

      <div class="space-y-4">
        <div *ngFor="let jornada of getJornadasUnicas()" 
             class="bg-white dark:bg-[#182c19] rounded-2xl border-2 border-gray-200 dark:border-[#2a452b] overflow-hidden">
          <div class="bg-gradient-to-r from-[#2E7D32] to-[#1B5E20] text-white px-6 py-4">
            <h4 class="text-xl font-bold">
              {{ tipoSeleccionado() === 'eliminacion_directa' ? getNombreRonda(Math.pow(2, getJornadasUnicas().length - jornada + 1)) : 'Jornada ' + jornada }}
            </h4>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div *ngFor="let partido of getPartidosPorJornada(jornada)"
                   class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-[#2E7D32] transition-all">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-600 dark:text-gray-400">
                    {{ partido.fecha }} - {{ partido.hora }}
                  </span>
                  <span *ngIf="partido.grupo" class="px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-bold">
                    {{ partido.grupo }}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-900 dark:text-white font-bold flex-1">{{ partido.equipoLocal }}</span>
                  <span class="px-3 text-gray-500 font-bold">VS</span>
                  <span class="text-gray-900 dark:text-white font-bold flex-1 text-right">{{ partido.equipoVisitante }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>