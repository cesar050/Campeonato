<div class="jugadores-container">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="material-symbols-outlined">group</span>
        Gesti√≥n de Jugadores
      </h1>
      <p class="page-subtitle">Administra los jugadores de tus equipos</p>
    </div>

    <!-- SELECTOR DE EQUIPO Y BOT√ìN AGREGAR -->
    <div class="header-actions">
      <select 
        *ngIf="misEquipos().length > 0"
        [(ngModel)]="equipoSeleccionado" 
        (change)="cambiarEquipo()"
        class="equipo-selector">
        <option [value]="null" disabled>Selecciona un equipo</option>
        <option *ngFor="let equipo of misEquipos()" [value]="equipo.id_equipo">
          {{ equipo.nombre }}
        </option>
      </select>

      <button 
        *ngIf="equipoSeleccionado()"
        class="btn-primary" 
        (click)="abrirModal()">
        <span class="material-symbols-outlined">add</span>
        Agregar Jugador
      </button>
    </div>
  </div>

  <!-- BARRA DE FILTROS -->
  <div *ngIf="equipoSeleccionado()" class="filtros-section">
    <div class="filtros-container">
      <div class="filtro-buscar">
        <span class="material-symbols-outlined">search</span>
        <input 
          type="text" 
          [value]="buscarTexto()"
          (input)="onSearchInput($event)"
          placeholder="Buscar por nombre, apellido o documento..."
          class="input-buscar"
          aria-label="Buscar jugadores">
        <span *ngIf="buscarTexto()" class="busqueda-indicador" title="B√∫squeda en tiempo real activa">
          <span class="material-symbols-outlined">sync</span>
        </span>
      </div>
      
      <select 
        [(ngModel)]="posicionFilter"
        (change)="aplicarFiltros()"
        class="filtro-select">
        <option value="">Todas las posiciones</option>
        <option value="portero">Portero</option>
        <option value="defensa">Defensa</option>
        <option value="mediocampista">Mediocampista</option>
        <option value="delantero">Delantero</option>
      </select>

      <button class="btn-filtrar" (click)="aplicarFiltros()">
        <span class="material-symbols-outlined">filter_list</span>
        Aplicar
      </button>

      <button 
        *ngIf="buscarTexto() || posicionFilter()"
        class="btn-limpiar" 
        (click)="limpiarFiltros()">
        <span class="material-symbols-outlined">clear</span>
        Limpiar
      </button>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading()" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando jugadores...</p>
  </div>

  <!-- EMPTY STATE - SIN EQUIPOS -->
  <div *ngIf="!loading() && misEquipos().length === 0" class="empty-state">
    <div class="empty-icon">
      <span class="material-symbols-outlined">shield</span>
    </div>
    <h2>No tienes equipos registrados</h2>
    <p>Primero debes tener un equipo para agregar jugadores</p>
    <button 
      [routerLink]="['/lider-equipo/mis-equipos']"
      class="btn-primary">
      <span class="material-symbols-outlined">shield</span>
      Ver Mis Equipos
    </button>
  </div>

  <!-- EMPTY STATE - SIN JUGADORES -->
  <div *ngIf="!loading() && misEquipos().length > 0 && jugadores().length === 0 && equipoSeleccionado()" class="empty-state">
    <div class="empty-icon">
      <span class="material-symbols-outlined">person_add</span>
    </div>
    <h2>No hay jugadores{{ buscarTexto() || posicionFilter() ? ' que coincidan con los filtros' : ' en este equipo' }}</h2>
    <p *ngIf="!buscarTexto() && !posicionFilter()">Agrega tu primer jugador para comenzar</p>
    <p *ngIf="buscarTexto() || posicionFilter()">Intenta ajustar los filtros de b√∫squeda</p>
    <button 
      *ngIf="!buscarTexto() && !posicionFilter()"
      class="btn-primary" 
      (click)="abrirModal()">
      <span class="material-symbols-outlined">add</span>
      Agregar Primer Jugador
    </button>
    <button 
      *ngIf="buscarTexto() || posicionFilter()"
      class="btn-secondary" 
      (click)="limpiarFiltros()">
      <span class="material-symbols-outlined">clear</span>
      Limpiar Filtros
    </button>
  </div>

  <!-- TABLA DE JUGADORES -->
  <div *ngIf="!loading() && jugadores().length > 0" class="jugadores-table-container">
    <table class="jugadores-table" role="table" aria-label="Lista de jugadores del equipo">
      <caption class="sr-only">
        Tabla de jugadores mostrando dorsal, nombre completo, documento, posici√≥n, edad y acciones disponibles
      </caption>
      <thead>
        <tr role="row">
          <th scope="col" role="columnheader">Dorsal</th>
          <th scope="col" role="columnheader">Nombre Completo</th>
          <th scope="col" role="columnheader">Documento</th>
          <th scope="col" role="columnheader">Posici√≥n</th>
          <th scope="col" role="columnheader">Edad</th>
          <th scope="col" role="columnheader">Documento PDF</th>
          <th scope="col" role="columnheader">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let jugador of jugadores(); let i = index" role="row" [attr.aria-rowindex]="i + 2">
          <td class="dorsal">
            <span class="dorsal-badge">{{ jugador.dorsal }}</span>
          </td>
          <td class="nombre">
            <div class="player-info">
              <span class="material-symbols-outlined player-icon">account_circle</span>
              <span class="player-name">{{ jugador.nombre }} {{ jugador.apellido }}</span>
            </div>
          </td>
          <td>{{ jugador.documento }}</td>
          <td>
            <span class="posicion-badge" [class]="'posicion-' + jugador.posicion">
              {{ getPosicionTexto(jugador.posicion) }}
            </span>
          </td>
          <td>
            {{ jugador.fecha_nacimiento ? calcularEdad(jugador.fecha_nacimiento) + ' a√±os' : 'N/A' }}
          </td>
          <td class="documento-cell">
            <div class="documento-actions">
              <span 
                *ngIf="jugador.documento_pdf" 
                class="documento-status has-doc"
                title="Documento subido">
                <span class="material-symbols-outlined">check_circle</span>
                Subido
              </span>
              <label 
                class="btn-upload"
                [class.uploading]="uploadingDocument()">
                <span class="material-symbols-outlined">upload_file</span>
                <span>{{ jugador.documento_pdf ? 'Reemplazar' : 'Subir' }}</span>
                <input 
                  type="file" 
                  accept="application/pdf"
                  (change)="onFileSelected($event, jugador)"
                  [disabled]="uploadingDocument()">
              </label>
            </div>
          </td>
          <td class="acciones">
            <!-- Ver PDF -->
            <button 
              *ngIf="jugador.documento_pdf"
              class="btn-icon btn-view" 
              (click)="verPDF(jugador)"
              title="Ver documento PDF">
              <span class="material-symbols-outlined">description</span>
            </button>
            
            <!-- Editar -->
            <button 
              class="btn-icon btn-edit" 
              (click)="abrirModal(jugador)"
              title="Editar jugador">
              <span class="material-symbols-outlined">edit</span>
            </button>
            
            <!-- Eliminar -->
            <button 
              class="btn-icon btn-delete" 
              (click)="eliminarJugador(jugador)"
              title="Eliminar jugador">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- PAGINACI√ìN -->
    <app-pagination
      *ngIf="totalPaginas() > 0"
      [currentPage]="paginaActual()"
      [totalPages]="totalPaginas()"
      [totalItems]="totalItems()"
      [itemsPerPage]="itemsPorPagina()"
      [itemsPerPageOptions]="[5, 10, 20, 50]"
      [showItemsPerPage]="true"
      [ariaLabel]="'Navegaci√≥n de paginaci√≥n de jugadores'"
      (pageChange)="cambiarPagina($event)"
      (itemsPerPageChange)="cambiarItemsPorPagina($event)">
    </app-pagination>
  </div>

  <!-- Contin√∫a en la siguiente parte... -->
   <!-- ============================================ -->
  <!-- MODAL DE FORMULARIO -->
  <!-- ============================================ -->
  <div *ngIf="showModal()" class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <span class="material-symbols-outlined">
            {{ isEditing() ? 'edit' : 'person_add' }}
          </span>
          {{ isEditing() ? 'Editar Jugador' : 'Agregar Jugador' }}
        </h2>
        <button class="btn-close" (click)="cerrarModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form [formGroup]="jugadorForm" (ngSubmit)="guardarJugador()" class="modal-body">
        
        <!-- ============================================ -->
        <!-- SECCI√ìN: DATOS PERSONALES -->
        <!-- ============================================ -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="material-symbols-outlined">badge</span>
            Datos Personales
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input 
                type="text" 
                id="nombre"
                formControlName="nombre"
                placeholder="Ej: Juan"
                maxlength="50"
                [class.invalid]="jugadorForm.get('nombre')?.invalid && jugadorForm.get('nombre')?.touched"
                aria-describedby="nombre-hint nombre-error">
              <small id="nombre-hint" class="form-hint">
                {{ jugadorForm.get('nombre')?.value?.length || 0 }}/50 caracteres
              </small>
              <span id="nombre-error" class="error" *ngIf="jugadorForm.get('nombre')?.invalid && jugadorForm.get('nombre')?.touched">
                <span *ngIf="jugadorForm.get('nombre')?.errors?.['required']">El nombre es requerido</span>
                <span *ngIf="jugadorForm.get('nombre')?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
              </span>
            </div>

            <div class="form-group">
              <label for="apellido">Apellido *</label>
              <input 
                type="text" 
                id="apellido"
                formControlName="apellido"
                placeholder="Ej: P√©rez"
                [class.invalid]="jugadorForm.get('apellido')?.invalid && jugadorForm.get('apellido')?.touched">
              <span class="error" *ngIf="jugadorForm.get('apellido')?.invalid && jugadorForm.get('apellido')?.touched">
                Apellido requerido (m√≠n. 2 caracteres)
              </span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="documento">
                Documento (CI) *
                <span class="material-symbols-outlined tooltip-icon" 
                      title="C√©dula de identidad de 10 d√≠gitos num√©ricos"
                      aria-label="Ayuda: Documento debe tener 10 d√≠gitos">info</span>
              </label>
              <input 
                type="text" 
                id="documento"
                formControlName="documento"
                placeholder="1234567890"
                maxlength="10"
                inputmode="numeric"
                pattern="[0-9]{10}"
                [class.invalid]="jugadorForm.get('documento')?.invalid && jugadorForm.get('documento')?.touched"
                aria-describedby="documento-hint documento-error">
              <small id="documento-hint" class="form-hint">
                {{ jugadorForm.get('documento')?.value?.length || 0 }}/10 d√≠gitos
              </small>
              <span id="documento-error" class="error" *ngIf="jugadorForm.get('documento')?.invalid && jugadorForm.get('documento')?.touched">
                <span *ngIf="jugadorForm.get('documento')?.errors?.['required']">Documento es requerido</span>
                <span *ngIf="jugadorForm.get('documento')?.errors?.['pattern']">Debe contener exactamente 10 d√≠gitos num√©ricos</span>
              </span>
            </div>

            <div class="form-group">
              <label for="fecha_nacimiento">Fecha de Nacimiento *</label>
              <input 
                type="date" 
                id="fecha_nacimiento"
                formControlName="fecha_nacimiento"
                [class.invalid]="jugadorForm.get('fecha_nacimiento')?.invalid && jugadorForm.get('fecha_nacimiento')?.touched">
              <span class="error" *ngIf="jugadorForm.get('fecha_nacimiento')?.invalid && jugadorForm.get('fecha_nacimiento')?.touched">
                Fecha de nacimiento requerida
              </span>
            </div>
          </div>
        </div>

        <!-- ============================================ -->
        <!-- SECCI√ìN: DATOS DEPORTIVOS -->
        <!-- ============================================ -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="material-symbols-outlined">sports_soccer</span>
            Datos Deportivos
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="dorsal">Dorsal *</label>
              <input 
                type="number" 
                id="dorsal"
                formControlName="dorsal"
                placeholder="1-99"
                min="1"
                max="99"
                [class.invalid]="jugadorForm.get('dorsal')?.invalid && jugadorForm.get('dorsal')?.touched">
              <span class="error" *ngIf="jugadorForm.get('dorsal')?.invalid && jugadorForm.get('dorsal')?.touched">
                Dorsal requerido (1-99)
              </span>
            </div>

            <div class="form-group">
              <label for="posicion">Posici√≥n *</label>
              <select 
                id="posicion"
                formControlName="posicion"
                [class.invalid]="jugadorForm.get('posicion')?.invalid && jugadorForm.get('posicion')?.touched">
                <option value="portero">Portero</option>
                <option value="defensa">Defensa</option>
                <option value="mediocampista">Mediocampista</option>
                <option value="delantero">Delantero</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ============================================ -->
        <!-- SECCI√ìN: ARCHIVOS -->
        <!-- ============================================ -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="material-symbols-outlined">upload_file</span>
            Documentos
          </h3>

          <div class="form-row">
            <!-- FOTO DEL JUGADOR -->
            <div class="form-group">
              <label>
                <span class="icon">üì∑</span>
                Foto del Jugador (Opcional)
              </label>
              
              <!-- Preview de la foto -->
              <div *ngIf="fotoPreview" class="foto-preview">
                <img [src]="fotoPreview" alt="Preview de la foto">
                <button 
                  type="button" 
                  class="btn-remove-preview"
                  (click)="removeFotoPreview()">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>

              <!-- Input de archivo -->
              <div class="file-input-wrapper" *ngIf="!fotoPreview">
                <input 
                  type="file" 
                  id="foto-input"
                  accept="image/*"
                  (change)="onFotoSelected($event)"
                  style="display: none;">
                
                <label 
                  for="foto-input" 
                  class="file-input-label">
                  <span class="material-symbols-outlined">upload</span>
                  <span>Seleccionar foto</span>
                </label>
              </div>

              <small class="form-hint">JPG, PNG o GIF. M√°ximo 2MB</small>
            </div>

            <!-- DOCUMENTO PDF -->
            <div class="form-group">
              <label>
                <span class="icon">üìÑ</span>
                Documento de Identidad {{ isEditing() ? '' : '*' }} (PDF)
              </label>
              
              <!-- Indicador de documento cargado -->
              <div *ngIf="documentoFile" class="documento-preview">
                <div class="documento-info">
                  <span class="material-symbols-outlined pdf-icon">picture_as_pdf</span>
                  <div class="documento-details">
                    <span class="documento-nombre">{{ documentoFile.name }}</span>
                    <span class="documento-size">{{ (documentoFile.size / 1024).toFixed(2) }} KB</span>
                  </div>
                </div>
                <button 
                  type="button" 
                  class="btn-remove-documento"
                  (click)="removeDocumento()">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>

              <!-- Input de archivo -->
              <div class="file-input-wrapper" *ngIf="!documentoFile">
                <input 
                  type="file" 
                  id="documento-input"
                  accept="application/pdf"
                  (change)="onDocumentoSelected($event)"
                  style="display: none;">
                
                <label 
                  for="documento-input" 
                  class="file-input-label documento-label">
                  <span class="material-symbols-outlined">upload_file</span>
                  <span>Seleccionar PDF</span>
                </label>
              </div>

              <small class="form-hint">
                C√©dula, DNI o pasaporte en formato PDF. M√°ximo 5MB
                <span *ngIf="!isEditing()" class="required-badge">Obligatorio</span>
              </small>
            </div>
          </div>
        </div>

        <!-- ============================================ -->
        <!-- BOTONES DEL MODAL -->
        <!-- ============================================ -->
        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="cerrarModal()">
            <span class="material-symbols-outlined">close</span>
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="jugadorForm.invalid">
            <span class="material-symbols-outlined">
              {{ isEditing() ? 'save' : 'add' }}
            </span>
            {{ isEditing() ? 'Guardar Cambios' : 'Agregar Jugador' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- VISOR DE PDF -->
  <!-- ============================================ -->
  <div *ngIf="showPDFViewer()" class="pdf-viewer-overlay" (click)="cerrarPDFViewer()">
    <div class="pdf-viewer-container" (click)="$event.stopPropagation()">
      <!-- Header del visor -->
      <div class="pdf-viewer-header">
        <div class="jugador-info">
          <span class="material-symbols-outlined">person</span>
          <div class="info-text">
            <h3>{{ currentJugadorPDF()?.nombre }} {{ currentJugadorPDF()?.apellido }}</h3>
            <p>Dorsal #{{ currentJugadorPDF()?.dorsal }} - {{ getPosicionTexto(currentJugadorPDF()?.posicion || '') }}</p>
          </div>
        </div>

        <div class="navigation-info">
          <span>{{ currentPDFIndex() + 1 }} de {{ allJugadoresConPDF.length }}</span>
        </div>

        <button class="btn-close-viewer" (click)="cerrarPDFViewer()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Contenedor del PDF -->
      <div class="pdf-content">
        <iframe 
          *ngIf="currentPDFUrl()"
          [src]="currentPDFUrl() | safe: 'resourceUrl'"
          class="pdf-iframe">
        </iframe>
      </div>

      <!-- Navegaci√≥n entre PDFs -->
      <div class="pdf-navigation">
        <button 
          class="nav-btn prev-btn"
          [disabled]="currentPDFIndex() === 0"
          (click)="anteriorPDF()">
          <span class="material-symbols-outlined">chevron_left</span>
          <span>Anterior</span>
        </button>

        <button 
          class="nav-btn next-btn"
          [disabled]="currentPDFIndex() === allJugadoresConPDF.length - 1"
          (click)="siguientePDF()">
          <span>Siguiente</span>
          <span class="material-symbols-outlined">chevron_right</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmaci√≥n: eliminar jugador -->
<app-confirm-dialog
  [show]="showConfirmEliminar()"
  title="Eliminar jugador"
  [message]="'¬øDeseas eliminar a ' + (jugadorAEliminar()?.nombre || 'este jugador') + ' ' + (jugadorAEliminar()?.apellido || '') + '?'"
  type="warning"
  (confirm)="confirmEliminarJugador($event.confirmed)">
</app-confirm-dialog>

<!-- Toast -->
<app-toast
  [show]="showToast()"
  [type]="toastType()"
  [title]="toastTitle()"
  [message]="toastMessage()"
  (close)="showToast.set(false)">
</app-toast>