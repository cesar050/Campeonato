<div class="formaciones-container min-h-screen bg-gray-50 dark:bg-[#102211]">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="material-symbols-outlined">grid_view</span>
        Formaciones
      </h1>
      <p class="page-subtitle">Crea y gestiona tus formaciones t√°cticas personalizadas</p>
    </div>
    <div class="header-actions">
      <button class="btn-create" (click)="crearNuevaFormacion('11')">
        <span class="material-symbols-outlined">add</span>
        Nueva Formaci√≥n 11
      </button>
      <button class="btn-create-indoor" (click)="crearNuevaFormacion('6')">
        <span class="material-symbols-outlined">add</span>
        Nueva Indoor
      </button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="filtros-container bg-white dark:bg-[#182c19] border-2 border-gray-200 dark:border-[#2a452b] rounded-xl p-4 mb-6">
    <div class="flex flex-wrap items-center gap-3">
      <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Filtrar por tipo:</span>
      <button 
        class="filtro-btn px-4 py-2 rounded-lg transition-all font-medium" 
        [class.active]="filtroTipo() === 'todas'"
        [class.bg-green-100]="filtroTipo() === 'todas'"
        [class.text-green-700]="filtroTipo() === 'todas'"
        [class.dark:bg-green-900/30]="filtroTipo() === 'todas'"
        [class.dark:text-green-300]="filtroTipo() === 'todas'"
        [class.bg-gray-100]="filtroTipo() !== 'todas'"
        [class.text-gray-700]="filtroTipo() !== 'todas'"
        [class.dark:bg-gray-800]="filtroTipo() !== 'todas'"
        [class.dark:text-gray-300]="filtroTipo() !== 'todas'"
        (click)="cambiarFiltro('todas')">
        <span class="material-symbols-outlined text-lg mr-2">apps</span>
        Todas ({{ contarTotal() }})
      </button>
      <button 
        class="filtro-btn px-4 py-2 rounded-lg transition-all font-medium" 
        [class.active]="filtroTipo() === '11'"
        [class.bg-green-100]="filtroTipo() === '11'"
        [class.text-green-700]="filtroTipo() === '11'"
        [class.dark:bg-green-900/30]="filtroTipo() === '11'"
        [class.dark:text-green-300]="filtroTipo() === '11'"
        [class.bg-gray-100]="filtroTipo() !== '11'"
        [class.text-gray-700]="filtroTipo() !== '11'"
        [class.dark:bg-gray-800]="filtroTipo() !== '11'"
        [class.dark:text-gray-300]="filtroTipo() !== '11'"
        (click)="cambiarFiltro('11')">
        <span class="material-symbols-outlined text-lg mr-2">sports_soccer</span>
        F√∫tbol 11 ({{ contarPorTipo11() }})
      </button>
      <button 
        class="filtro-btn px-4 py-2 rounded-lg transition-all font-medium" 
        [class.active]="filtroTipo() === '6'"
        [class.bg-green-100]="filtroTipo() === '6'"
        [class.text-green-700]="filtroTipo() === '6'"
        [class.dark:bg-green-900/30]="filtroTipo() === '6'"
        [class.dark:text-green-300]="filtroTipo() === '6'"
        [class.bg-gray-100]="filtroTipo() !== '6'"
        [class.text-gray-700]="filtroTipo() !== '6'"
        [class.dark:bg-gray-800]="filtroTipo() !== '6'"
        [class.dark:text-gray-300]="filtroTipo() !== '6'"
        (click)="cambiarFiltro('6')">
        <span class="material-symbols-outlined text-lg mr-2">stadium</span>
        Indoor ({{ contarPorTipo6() }})
      </button>
    </div>
  </div>

  <!-- PAGINACI√ìN SUPERIOR -->
  <app-pagination
    *ngIf="formacionesFiltradas().length > 0"
    [currentPage]="currentPage()"
    [totalPages]="totalPages()"
    [totalItems]="formacionesFiltradas().length"
    [itemsPerPage]="itemsPerPage()"
    [itemsPerPageOptions]="[5, 6, 9, 12, 18, 24]"
    (pageChange)="onPageChange($event)"
    (itemsPerPageChange)="onItemsPerPageChange($event)"
    ariaLabel="Navegaci√≥n de formaciones">
  </app-pagination>

  <!-- GRID DE FORMACIONES -->
  <div class="formaciones-grid">
    <div 
      *ngFor="let formacion of formacionesPaginadas()" 
      class="formacion-card bg-white dark:bg-[#182c19] border-2 border-gray-200 dark:border-[#2a452b]"
      [class.personalizada]="formacion.personalizada">
      
      <!-- BADGE TIPO -->
      <div class="tipo-badge" [class.indoor]="formacion.tipo === '6'">
        {{ formacion.tipo === '11' ? 'F√∫tbol 11' : 'Indoor' }}
      </div>

      <!-- CANCHA PREVIEW -->
      <div class="cancha-preview" [class.cancha-indoor]="formacion.tipo === '6'">
        <div class="cancha-lineas-mini">
          <div class="linea-media-mini"></div>
          <div class="circulo-central-mini"></div>
        </div>
        
        <!-- POSICIONES -->
        <div 
          *ngFor="let pos of formacion.posiciones"
          class="posicion-mini"
          [style.left.%]="pos.x"
          [style.top.%]="pos.y">
          <div class="dot"></div>
        </div>
      </div>

      <!-- INFO -->
      <div class="formacion-info">
        <h3 class="formacion-nombre">
          {{ formacion.nombre }}
          <span class="custom-badge" *ngIf="formacion.personalizada">
            <span class="material-symbols-outlined">star</span>
          </span>
        </h3>
        <p class="formacion-descripcion">
          {{ formacion.posiciones.length }} jugadores ‚Ä¢ {{ formacion.codigo }}
        </p>
      </div>

      <!-- ACCIONES -->
      <div class="formacion-acciones">
        <button 
          class="btn-accion edit" 
          (click)="editarFormacion(formacion)"
          *ngIf="formacion.personalizada"
          title="Editar">
          <span class="material-symbols-outlined">edit</span>
        </button>
        
        <button 
          class="btn-accion" 
          (click)="duplicarFormacion(formacion)"
          title="Duplicar">
          <span class="material-symbols-outlined">content_copy</span>
        </button>
        
        <button 
          class="btn-accion danger" 
          (click)="eliminarFormacion(formacion)"
          *ngIf="formacion.personalizada"
          title="Eliminar">
          <span class="material-symbols-outlined">delete</span>
        </button>
      </div>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <!-- PAGINACI√ìN -->
  <app-pagination
    *ngIf="formacionesFiltradas().length > 0"
    [currentPage]="currentPage()"
    [totalPages]="totalPages()"
    [totalItems]="formacionesFiltradas().length"
    [itemsPerPage]="itemsPerPage()"
    [itemsPerPageOptions]="[5, 6, 9, 12, 18, 24]"
    (pageChange)="onPageChange($event)"
    (itemsPerPageChange)="onItemsPerPageChange($event)"
    ariaLabel="Navegaci√≥n de formaciones">
  </app-pagination>

  <div class="empty-state" *ngIf="formacionesFiltradas().length === 0">
    <div class="empty-icon">
      <span class="material-symbols-outlined">grid_view</span>
    </div>
    <h2>No hay formaciones {{ filtroTipo() === '11' ? 'de F√∫tbol 11' : filtroTipo() === '6' ? 'Indoor' : '' }}</h2>
    <p>Crea tu primera formaci√≥n personalizada haciendo clic en el bot√≥n "Nueva Formaci√≥n"</p>
  </div>

  <!-- MODAL CREAR/EDITAR FORMACI√ìN -->
  <div class="modal-overlay" *ngIf="modoCreacion()" (click)="cancelarEdicion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <span class="material-symbols-outlined">edit</span>
          {{ formacionEnEdicion()?.nombre ? 'Editar' : 'Crear' }} Formaci√≥n Personalizada
        </h2>
        <button class="modal-close" (click)="cancelarEdicion()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="instrucciones-box">
          <h3>
            <span class="material-symbols-outlined">info</span>
            Instrucciones
          </h3>
          <ol>
            <li>Define el nombre de tu formaci√≥n (ej: 5-2-2-1)</li>
            <li>Selecciona el tipo de posici√≥n en el selector</li>
            <li>Haz clic en la cancha para agregar cada posici√≥n</li>
            <li>Debes colocar exactamente {{ formacionEnEdicion()?.tipo === '11' ? '11' : '6' }} jugadores</li>
            <li>Haz clic en el n√∫mero de una posici√≥n para eliminarla</li>
          </ol>
        </div>

        <!-- NOMBRE DE FORMACI√ìN -->
        <div class="form-group">
          <label for="nombre-formacion">
            <span class="material-symbols-outlined">edit</span>
            Nombre de la Formaci√≥n
          </label>
          <input 
            #nombreFormacion
            id="nombre-formacion"
            type="text" 
            [value]="formacionEnEdicion()?.nombre || ''"
            placeholder="Ej: 5-2-2-1 Ultra Ofensiva"
            class="input-text"
            maxlength="30">
        </div>

        <!-- TIPO DE POSICI√ìN -->
        <div class="form-group">
          <label for="tipo-posicion">
            <span class="material-symbols-outlined">person</span>
            Tipo de Posici√≥n (selecciona antes de hacer clic en la cancha)
          </label>
          <select #tipoPosicion id="tipo-posicion" class="select-custom">
            <option value="Portero">‚öΩ Portero</option>
            <option value="Defensa" selected>üõ°Ô∏è Defensa</option>
            <option value="Mediocampista">üèÉ Mediocampista</option>
            <option value="Delantero">‚ö° Delantero</option>
          </select>
        </div>

        <!-- CONTADOR -->
        <div class="contador-posiciones">
          <div class="contador-item main">
            <span class="material-symbols-outlined">groups</span>
            <span><strong>{{ (formacionEnEdicion()?.posiciones?.length || 0) }}</strong> / {{ formacionEnEdicion()?.tipo === '11' ? '11' : '6' }}</span>
          </div>
          <div class="contador-item">
            <span class="material-symbols-outlined">sports</span>
            <span>{{ contarPorTipo('Portero') }} Porteros</span>
          </div>
          <div class="contador-item">
            <span class="material-symbols-outlined">shield</span>
            <span>{{ contarPorTipo('Defensa') }} Defensas</span>
          </div>
          <div class="contador-item">
            <span class="material-symbols-outlined">directions_run</span>
            <span>{{ contarPorTipo('Mediocampista') }} Medios</span>
          </div>
          <div class="contador-item">
            <span class="material-symbols-outlined">sports_soccer</span>
            <span>{{ contarPorTipo('Delantero') }} Delanteros</span>
          </div>
        </div>

        <!-- CANCHA INTERACTIVA -->
        <div class="cancha-editor-container">
          <h4>
            <span class="material-symbols-outlined">touch_app</span>
            Haz clic en la cancha para agregar posiciones
          </h4>
          <div 
            class="cancha-editor" 
            [class.cancha-indoor]="formacionEnEdicion()?.tipo === '6'"
            (click)="onCanchaClick($event, tipoPosicion.value)">
            
            <!-- L√çNEAS -->
            <div class="cancha-lineas">
              <div class="linea-media"></div>
              <div class="circulo-central"></div>
              <div class="area-grande area-grande-arriba"></div>
              <div class="area-chica area-chica-arriba"></div>
              <div class="area-grande area-grande-abajo"></div>
              <div class="area-chica area-chica-abajo"></div>
            </div>

            <!-- POSICIONES AGREGADAS -->
            <div 
              *ngFor="let pos of formacionEnEdicion()?.posiciones; let i = index"
              class="posicion-agregada"
              [style.left.%]="pos.x"
              [style.top.%]="pos.y"
              (click)="$event.stopPropagation()">
              <div class="posicion-dot" [class]="pos.posicion.toLowerCase()">
                <span class="posicion-label">{{ i + 1 }}</span>
              </div>
              <button class="btn-eliminar-pos" (click)="eliminarPosicion(i)" title="Eliminar posici√≥n">
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>

            <!-- MENSAJE VAC√çO -->
            <div class="cancha-empty" *ngIf="(formacionEnEdicion()?.posiciones?.length || 0) === 0">
              <span class="material-symbols-outlined">touch_app</span>
              <p>Haz clic para agregar posiciones</p>
            </div>
          </div>
        </div>

        <!-- LISTA DE POSICIONES CREADAS -->
        <div class="posiciones-list" *ngIf="(formacionEnEdicion()?.posiciones?.length || 0) > 0">
          <h4>
            <span class="material-symbols-outlined">format_list_numbered</span>
            Posiciones Agregadas ({{ formacionEnEdicion()?.posiciones?.length || 0 }}):
          </h4>
          <div class="posicion-item" *ngFor="let pos of formacionEnEdicion()?.posiciones; let i = index">
            <span class="posicion-numero">{{ i + 1 }}</span>
            <span class="posicion-tipo" [class]="pos.posicion.toLowerCase()">
              <span class="material-symbols-outlined">
                {{ pos.posicion === 'Portero' ? 'sports' : 
                   pos.posicion === 'Defensa' ? 'shield' : 
                   pos.posicion === 'Mediocampista' ? 'directions_run' : 'sports_soccer' }}
              </span>
              {{ pos.posicion }}
            </span>
            <span class="posicion-coords">({{ pos.x }}%, {{ pos.y }}%)</span>
            <button class="btn-remove-small" (click)="eliminarPosicion(i)" title="Eliminar">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="cancelarEdicion()">
          <span class="material-symbols-outlined">close</span>
          Cancelar
        </button>
        
        <button 
          class="btn-primary"
          (click)="guardarFormacion(nombreFormacion.value)"
          [disabled]="!nombreFormacion.value || !esFormacionCompleta()">
          <span class="material-symbols-outlined">save</span>
          Guardar Formaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmaci√≥n: eliminar formaci√≥n -->
<app-confirm-dialog
  [show]="showConfirmEliminar()"
  title="Eliminar formaci√≥n"
  [message]="'¬øDeseas eliminar la formaci√≥n ' + (formacionAEliminar()?.nombre || '') + '?'"
  type="warning"
  (confirm)="confirmEliminar($event.confirmed)">
</app-confirm-dialog>

<!-- Toast -->
<app-toast
  [show]="showToast()"
  [type]="toastType()"
  [title]="toastTitle()"
  [message]="toastMessage()"
  (close)="showToast.set(false)">
</app-toast>